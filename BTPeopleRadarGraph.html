<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>People Group Radar Graph</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        
        <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300&display=swap" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <link rel="stylesheet" href="./styles/Common.css" />
        <link rel="stylesheet" href="./styles/Error.css" />
        <link rel="stylesheet" href="./styles/BTPeopleRadarGraph.css" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.22.4/dist/bootstrap-table.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">       
    
        <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.22.4/dist/bootstrap-table.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js" integrity="sha512-ZwR1/gSZM3ai6vCdI+LVF1zSq/5HznD3ZSTk7kajkaj4D292NLuduDCO1c/NT8Id+jE58KYLKT7hXnbtryGmMg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
 </head>
    <body>
        <div id="liveAlertPlaceholder"></div>
        <div class="alert hidden" id="alert" role="alert"></div>
        <div id="radar-graph-grid">
            <div id="radar-graph-1" class="radar-graph container">
                <div class="row"><h1 class="title bold text-middle col-12">Group People Radar Graph</h1></div>
                <div class="row">
                    <h2 id="rg-companyname" class="companyname text-middle col-12"></h2>
                </div>
                <div class="row">
                    <div class="col-12">
                        <canvas id="rg-graph"></canvas>
                    </div>
                    <div class="col-12">
                        <table
                            id="rg-table"
                            class="score-table"
                            data-toggle="table"
                            data-show-footer="true"
                            data-checkbox-header="true"
                            data-click-to-select="true"
                            data-sortable="true"
                            data-sort-name="fullName"
                            data-sort-order="asc"
                            data-show-columns="true">
                            <thead>
                                <tr>
                                    <th class="col-1"></th>
                                    <th class="col-4"></th>
                                    <th class="col-1 vertical text-middle mover">Mover</th>
                                    <th class="col-1 vertical text-middle doer">Doer</th>
                                    <th class="col-1 vertical text-middle influencer">Influencer</th>
                                    <th class="col-1 vertical text-middle responder">Responder</th>
                                    <th class="col-1 vertical text-middle shaper">Shaper</th>
                                    <th class="col-1 vertical text-middle producer">Producer</th>
                                    <th class="col-1 vertical text-middle contemplator">Contemplator</th>
                                </tr>
                                <tr>
                                    <th
                                        data-field="state"
                                        data-checkbox="true"
                                        data-sortable="false"
                                        class="col-1"></th>
                                    <th 
                                        data-field="fullName" 
                                        data-footer-formatter="groupAverage"
                                        data-switchable="false"
                                        data-sortable="true" 
                                        data-sort-order="asc"
                                        class="col-4 fullName">Name
                                    </th>
                                    <th
                                        data-field="mover"
                                        data-footer-formatter="avgFooterFormatter"
                                        data-switchable-label="Mover"
                                        data-sortable="true"
                                        data-sort-="desc"
                                        class="col-1 mover">&nbsp;
                                    </th>
                                    <th
                                        data-field="doer"
                                        data-switchable-label="Doer"
                                        data-footer-formatter="avgFooterFormatter"
                                        data-sortable="true" 
                                        data-sort-="desc"
                                        class="col-1 doer">&nbsp;
                                    </th>
                                    <th
                                        data-field="influencer"
                                        data-switchable-label="Influencer"
                                        data-footer-formatter="avgFooterFormatter"                                       
                                        data-sortable="true" 
                                        order="desc"
                                        class="col-1 influencer">&nbsp;
                                    </th>
                                    <th
                                        data-field="responder"
                                        data-switchable-label="Responder"
                                        data-footer-formatter="avgFooterFormatter"                                       
                                        data-sortable="true" 
                                        data-sort-="desc"
                                        class="col-1 responder">&nbsp;
                                    </th>
                                    <th
                                        data-field="shaper"
                                        data-switchable-label="Shaper"
                                        data-footer-formatter="avgFooterFormatter"                                       
                                        data-sortable="true" 
                                        order="desc"
                                        class="col-1 shaper">&nbsp;
                                    </th>
                                    <th
                                        data-field="producer"
                                        data-switchable-label="Producer"
                                        data-footer-formatter="avgFooterFormatter"                                       
                                        data-sortable="true" 
                                        data-sort-="desc"
                                        class="col-1 producer">&nbsp;
                                    </th>
                                    <th
                                        data-field="contemplator"
                                        data-switchable-label="Contemplator"
                                        data-footer-formatter="avgFooterFormatter"                                       
                                        data-sortable="true" 
                                        data-sort-="desc"
                                        class="col-1 contemplator">&nbsp;
                                    </th>
                                </tr>
                            </thead>                    
                        </table>                    
                    </div>
                </div>
                <div class="row">
                    <div class="copyright col-12">
                        Copyright &copy; Life Languages International.
                    </div>
                </div>
            </div>
        </div>        
        <script type="module">

            import { ERROR } from "./modules/Error.js";
            import { displayRadarGraphAndTable, avgFooterFormatter, groupAverageLabel } from "./modules/BTPeopleRadarGraph.js";
            import { convertCSVtoJSON } from "./modules/CSVToJSON.js";
            import { LLKEYS } from './modules/Common.js';
            
            // Formatters for BT need to be global?
            window.avgFooterFormatter = avgFooterFormatter;
            window.groupAverage = groupAverageLabel;
            
            let url = new URL(window.location.href);

            // Test data generation
            import { testJSON, testCSV, testInvalidData } from "./modules/BTPeopleRadarGraph.test.js";
            //url = testJSON('https://www.relatematters.com/coaching-tools/BTPeopleRadarGraph.html');
            url = testCSV('https://www.relatematters.com/coaching-tools/BTPeopleRadarGraph.html');
            //url = testInvalidData('https://www.relatematters.com/coaching-tools/BTPeopleRadarGraph.html');
           
            $('document').ready(function () {
                try {
                    function parseNumber(key, value) {
                        if (typeof value == 'number') return value;
                        let nValue = parseFloat(value);
                        if (Number.isNaN(nValue)) return value;
                        return nValue;
                    }

                    function parseString(key, value) {
                        return value;
                    }

                    const parseKeys = {
                        fullName: parseString,
                        mover: parseNumber,
                        doer: parseNumber,
                        responder: parseNumber,
                        influencer: parseNumber,
                        shaper: parseNumber,
                        producer: parseNumber,
                        contemplator: parseNumber,
                        overallIntensity: parseNumber,
                        companyName: parseString
                    };

                    let searchParams = url.searchParams;
                    let params = {};

                    if (searchParams.has('json')) {
                        params = JSON.parse(searchParams.get('json'));
                    } else if (searchParams.has('csv')) {
                        params = convertCSVtoJSON(searchParams.get('csv'));
                    } else {
                        ERROR.assert(false, 'Missing csv or json data in URL.');
                    }

                    // Parse all the parameters, CSV and forms have strings for numbers, we need to convert them.
                    for (let i = 0; i < params.length; i++) {
                        for (const [key, value] of Object.entries(params[i])) {
                            params[i][key] =
                                (key in parseKeys) ? parseKeys[key](key, value) : value;
                        }
                    }

                    displayRadarGraphAndTable(params);
                } catch (e) {
                    console.log(e);
                    ERROR.appendAlert(e, 'error');
                }
            });
        </script>
    </body>
</html>