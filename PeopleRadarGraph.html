<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Life Language Group Radar Graph</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js" integrity="sha512-ZwR1/gSZM3ai6vCdI+LVF1zSq/5HznD3ZSTk7kajkaj4D292NLuduDCO1c/NT8Id+jE58KYLKT7hXnbtryGmMg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <!--<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>-->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300&display=swap"
            rel="stylesheet" />
        <!--<link rel="stylesheet" href="./styles/simple-grid.css" />-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <link rel="stylesheet" href="./styles/Common.css" />
        <link rel="stylesheet" href="./styles/Error.css" />
        <link rel="stylesheet" href="./styles/PeopleRadarGraph.css" />
    </head>
    <body>
        <div id="liveAlertPlaceholder"></div>
        <div class="alert hidden" id="alert" role="alert"></div>
        <div id="radar-graph-grid">
            <div id="radar-graph-1" class="radar-graph container">
                <div class="row"><h1 class="title bold col-12"></h1></div>
                <div class="row">
                    <h2 id="rg-companyname" class="companyname col-12"></h2>
                </div>
                <div class="row">
                    <div id="rg-display" class="display col-xs-12 col-md-6">
                        <canvas class="radarGraph"></canvas>
                    </div>
                    <div class="col-xs-12 col-md-6">
                    <table id="rg-scores" class="score-table table table-striped">
                        <thead class="score-header"></thead>
                        <tbody class="score-body"></tbody>
                        <tfoot class="score-footer"></tfoot>
                    </table>
                        </div>
                </div>
                <div class="row">
                    <div class="copyright col-12">
                        Copyright &copy; Life Languages International.
                    </div>
                </div>
            </div>
        </div>        
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
        <script type="module">
            import { appendAlert, ASSERT, ASSERT_TYPE} from "./modules/Error.js";
            import { displayRadarGraphAndTable } from "./modules/PeopleRadarGraph.js";
            import { convertCSVtoJSON } from "./modules/CSVToJSON.js";
            import { LLKEYS } from './modules/Common.js';

            let url = new URL(window.location.href);

            // Test data generation
            //import { testJSON, testCSV, testInvalidData } from "./modules/PeopleRadarGraph.test.js";
            //url = testJSON('https://www.relatematters.com/coaching-tools/PeopleRadarGraph.html');
            //url = testCSV('https://www.relatematters.com/coaching-tools/PeopleRadarGraph.html');
            //url = testInvalidData('https://www.relatematters.com/coaching-tools/PeopleRadarGraph.html');

            try {
                function parseNumber(key, value) {
                    if (typeof value == 'number') return value;
                    let nValue = parseFloat(value);
                    if (Number.isNaN(nValue)) return value;
                    return nValue;
                }

                function parseString(key, value) {
                    return value;
                }

                const parseKeys = {
                    fullName: parseString,
                    mover: parseNumber,
                    doer: parseNumber,
                    responder: parseNumber,
                    influencer: parseNumber,
                    shaper: parseNumber,
                    producer: parseNumber,
                    contemplator: parseNumber,
                    overallIntensity: parseNumber,
                    companyName: parseString
                };

                let searchParams = url.searchParams;
                let params = {};

                if (searchParams.has('json')) {
                    params = JSON.parse(searchParams.get('json'));
                } else if (searchParams.has('csv')) {
                    params = convertCSVtoJSON(searchParams.get('csv'));
                } else {
                    ASSERT(false, 'Missing csv or json data in URL.');
                }

                // Parse all the parameters, CSV and forms have strings for numbers, we need to convert them.
                for (let i = 0; i < params.length; i++) {
                    for (const [key, value] of Object.entries(params[i])) {
                        params[i][key] =
                            (key in parseKeys) ? parseKeys[key](key, value) : value;
                    }
                }

                displayRadarGraphAndTable(1, params);
            } catch (e) {
                console.log(e);
                appendAlert(e, 'error');
            }
        </script>
    </body>
</html>