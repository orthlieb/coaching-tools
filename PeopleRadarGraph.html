<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Life Language Group Radar Graph</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300&display=swap"
            rel="stylesheet" />
        <link rel="stylesheet" href="./styles/Common.css" />
        <link rel="stylesheet" href="./styles/Error.css" />
        <link rel="stylesheet" href="./styles/PeopleRadarGraph.css" />
    </head>
    <body>
        <div class="alert hidden" id="alert" role="alert"></div>
        <div id="radar-graph-grid" class="row">
            <div id="radar-graph-1">
                <div class="title"></div>
                <div id="rg-companyname" class="companyname bold"></div>
                <div id="rg-display" class="display">
                    <canvas class="radarGraph"></canvas>
                </div>
                <table id="rg-scores" class="score-table">
                    <thead class="score-header"></thead>
                    <tbody class="score-body"></tbody>
                    <tfoot class="score-footer"></tfoot>
                </table>
                
                <div class="copyright">
                    Copyright &copy; Life Languages International.
                </div>
            </div>
        </div>
        <script type="module">
            import { displayAlertInDoc, ASSERT, ASSERT_TYPE} from "./modules/Error.js";
            import { displayRadarGraphAndTable } from "./modules/PeopleRadarGraph.js";
            import { convertCSVtoJSON } from "./modules/CSVToJSON.js";
            import { LLKEYS } from './modules/Common.js';

            let url = new URL(window.location.href);

            // Test data generation
            import { testJSON, testCSV, testInvalidData } from "./modules/PeopleRadarGraph.test.js";
            //url = testJSON('https://www.relatematters.com/coaching-tools/PeopleRadarGraph.html');
            url = testCSV('https://www.relatematters.com/coaching-tools/PeopleRadarGraph.html');
            //url = testInvalidData('https://www.relatematters.com/coaching-tools/PeopleRadarGraph.html');

            try {
                function parseNumber(key, value) {
                    if (typeof value == 'number') return value;
                    let nValue = parseFloat(value);
                    if (Number.isNaN(nValue)) return value;
                    return nValue;
                }

                function parseString(key, value) {
                    return value;
                }

                const parseKeys = {
                    fullName: parseString,
                    mover: parseNumber,
                    doer: parseNumber,
                    responder: parseNumber,
                    influencer: parseNumber,
                    shaper: parseNumber,
                    producer: parseNumber,
                    contemplator: parseNumber,
                    overallIntensity: parseNumber,
                    companyName: parseString
                };

                let searchParams = url.searchParams;
                let params = {};

                if (searchParams.has('json')) {
                    params = JSON.parse(searchParams.get('json'));
                } else if (searchParams.has('csv')) {
                    params = convertCSVtoJSON(searchParams.get('csv'));
                } else {
                    ASSERT(false, 'Missing csv or json data in URL.');
                }

                // Parse all the parameters, CSV and forms have strings for numbers, we need to convert them.
                for (let i = 0; i < params.length; i++) {
                    for (const [key, value] of Object.entries(params[i])) {
                        params[i][key] =
                            (key in parseKeys) ? parseKeys[key](key, value) : value;
                    }
                }

                displayRadarGraphAndTable(1, params);
            } catch (e) {
                displayAlertInDoc(e);
            }
        </script>
    </body>
</html>