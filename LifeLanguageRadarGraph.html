<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Life Language Group Radar Graph</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300&display=swap"
            rel="stylesheet" />
        <link rel="stylesheet" href="./styles/LifeLanguageRadarGraph.css" />
        <link rel="stylesheet" href="./styles/Error.css" />
    </head>
    <body>
        <div class="alert hidden" id="alert" role="alert"></div>
        <div id="radar-graph-grid" class="row">
            <div id="radar-graph-1">
                <div class="title"></div>
                <div id="rg-companyname" class="companyname"></div>
                <div id="rg-display" class="display">
                    <canvas class="radarGraph"></canvas>
                </div>
                <table id="rg-table" class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th class="align-right">Overall Intensity</th>
                            <th class="align-right">Score</th>
                        </tr>
                    </thead>
                    <tbody class="table-body"></tbody>
                    <tfoot class="table-foot bold"></tfoot>
                </table>
            <div class="copyright">
                    Copyright &copy; Life Languages International.
                </div>
            </div>
        </div>
        <script type="module">
            import { displayAlertInDoc, ASSERT, ASSERT_TYPE} from "./modules/Error.js";
            import { displayRadarGraph } from "./modules/LifeLanguageRadarGraph.js";
            import { convertCSVtoJSON } from "./modules/CSVToJSON.js";
            import { LLKEYS } from './modules/Common.js';

            let url = new URL(window.location.href);

            // Test data generation
            //import { testJSON, testCSV, testInvalidData } from "./modules/LifeLanguageRadarGraph.test.js";
            //url = testJSON('https://www.relatematters.com/coaching-tools/LifeLanguageRadarGraph.html');
            //url = testCSV('https://www.relatematters.com/coaching-tools/LangLifeLanguageRadarGraph.html');
            //url = testInvalidData('https://www.relatematters.com/coaching-tools/LifeLanguageRadarGraph.html');

            try {
                function parseNumber(key, value) {
                    if (typeof value == 'number') return value;
                    let nValue = parseFloat(value);
                    if (Number.isNaN(nValue)) return value;
                    return nValue;
                }

                function parseString(key, value) {
                    return value;
                }

                const parseKeys = {
                    fullName: parseString,
                    mover: parseNumber,
                    doer: parseNumber,
                    responder: parseNumber,
                    influencer: parseNumber,
                    shaper: parseNumber,
                    producer: parseNumber,
                    contemplator: parseNumber,
                    overallIntensity: parseNumber,
                    companyName: parseString
                };

                let searchParams = url.searchParams;
                let params = {};

                if (searchParams.has('json')) {
                    params = JSON.parse(searchParams.get('json'));
                } else if (searchParams.has('csv')) {
                    params = convertCSVtoJSON(searchParams.get('csv'));
                } else {
                    ASSERT(false, 'Missing csv or json data in URL.');
                }

                // Parse all the parameters, CSV and forms have strings for numbers, we need to convert them.
                for (let i = 0; i < params.length; i++) {
                    for (const [key, value] of Object.entries(params[i])) {
                        params[i][key] =
                            (key in parseKeys) ? parseKeys[key](key, value) : value;
                    }
                }

                let rgGrid = document.getElementById('radar-graph-grid');
                
                // Loop over each Life Language
                for (let i = 0; i < LLKEYS.length; i++) {
                    let chunk = document.getElementById('radar-graph-1');
                    if (i > 0) {
                        // Create our page from the existing one
                        let divClone = chunk.cloneNode(true); // the true is for deep cloning
                        divClone.setAttribute('id', 'radar-graph-' + (i + 1));
   
                        rgGrid.appendChild(divClone);
                    }
                    try {
                        displayRadarGraph(i + 1, params, LLKEYS[i]);
                    } catch (e) {
                        displayAlertInDoc(e);
                    }
                }
            } catch (e) {
                displayAlertInDoc(e);
            }
        </script>
    </body>
</html>