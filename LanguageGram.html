<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>LanguageGram</title>
        <link rel="stylesheet" href="./styles/Common.css" />
        <link rel="stylesheet" href="./styles/LanguageGram.css" />
        <link rel="stylesheet" href="./styles/Error.css" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <!--<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />-->
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300&display=swap"
            rel="stylesheet" />
    </head>
    <body>
        <div class="alert hidden" id="alert" role="alert"></div>
        <div id="language-gram-grid" class="row">
            <div id="language-gram-1" class="col-s-6 col-4">
                <div id="lg-fullname" class="fullname bold"></div>
                <div id="lg-companyname" class="companyname"></div>
                <div id="lg-letter-1" class="letter-1 bold uppercase"></div>
                <div id="lg-score-1" class="score-1 bold"></div>
                <div id="lg-llang-1" class="llang-1 capitalize"></div>
                <div id="lg-letter-2" class="letter-2 bold uppercase"></div>
                <div id="lg-score-2" class="score-2 bold"></div>
                <div id="lg-llang-2" class="llang-2 capitalize"></div>
                <div id="lg-letter-3" class="letter-3 bold uppercase"></div>
                <div id="lg-score-3" class="score-3 bold"></div>
                <div id="lg-llang-3" class="llang-3 capitalize"></div>
                <div id="lg-letter-4" class="letter-4 bold uppercase"></div>
                <div id="lg-score-4" class="score-4"></div>
                <div id="lg-llang-4" class="llang-4 capitalize"></div>
                <div id="lg-letter-5" class="letter-5 bold uppercase"></div>
                <div id="lg-score-5" class="score-5"></div>
                <div id="lg-llang-5" class="llang-5 capitalize"></div>
                <div id="lg-letter-6" class="letter-6 bold uppercase"></div>
                <div id="lg-score-6" class="score-6"></div>
                <div id="lg-llang-6" class="llang-6 capitalize"></div>
                <div id="lg-letter-7" class="letter-7 bold uppercase"></div>
                <div id="lg-score-7" class="score-7"></div>
                <div id="lg-llang-7" class="llang-7 capitalize"></div>
                <div id="lg-range-title" class="range-title">Range</div>
                <div id="lg-range-score" class="range-score"></div>
                <div
                    id="lg-overall-intensity-title"
                    class="overall-intensity-title">
                    Overall<br />Intensity
                </div>
                <div id="lg-overall-intensity" class="overall-intensity">
                    <span
                        id="lg-overall-intensity-arrow"
                        class="overall-intensity-arrow gray">
                    </span>
                    &nbsp;
                    <span
                        id="lg-overall-intensity-score"
                        class="overall-intensity-score">
                    </span>
                </div>
                <div class="copyright">
                    Copyright &copy; Life Languages International.
                </div>
            </div>
        </div>
        <script type="module">
            import { ERROR } from "./modules/Error.js";
            import { DEBUG } from "./modules/Debug.js";
            import { displayLanguageGram } from "./modules/LanguageGram.js";
            import { convertCSVtoJSON } from "./modules/CSVToJSON.js";

            let url = new URL(window.location.href);

            // Test data generation
            import { testCSV } from "./modules/LanguageGram.test.js";
            //import { testSingle, testJSON, testInvalidJSON } from "./modules/LanguageGram.test.js";
            //url = testSingle("https://www.relatematters.com/coaching-tools/LanguageGram.html");
            //url = testJSON("https://www.relatematters.com/coaching-tools/LanguageGram.html");
            //url = testCSV("https://www.relatematters.com/coaching-tools/LanguageGram.html");
            //url = testInvalidJSON("https://www.relatematters.com/coaching-tools/LanguageGram.html");

            try {
                let searchParams = url.searchParams;
                let params = {};

                if (searchParams.has('json')) {
                    params = JSON.parse(searchParams.get('json'));
                } else if (searchParams.has('csv')) {
                    params = convertCSVtoJSON(searchParams.get('csv'));
                } else {
                    let bFlag = false;
                    for (const [key, value] of searchParams.entries()) {
                        bFlag = true;
                        params[key] = value;
                    }
                    if (!bFlag) {
                        // No data found, generate data.
                        DEBUG.log('No data specified, generating test data');
                        url = testCSV('https://www.relatematters.com/coaching-tools/LanguageGram.html');
                        params = convertCSVtoJSON(url.searchParams.get('csv')); 
                     }
                }
            
                // We deal in arrays, so if the params are a singleton, enclose it in an array.
                if (!Array.isArray(params)) 
                    params = [params];

                // Utilities to parse the data from string inputs, which happen with GET and CSV
                function parseNumber(key, value) {
                    if (typeof value == 'number') return value;
                    let nValue = parseFloat(value);
                    if (Number.isNaN(nValue)) return value;
                    return nValue;
                }
 
                function parseString(key, value) {
                    return value;
                }

                const parseKeys = {
                    fullName: parseString,
                    companyName: parseString,
                    mover: parseNumber,
                    doer: parseNumber,
                    responder: parseNumber,
                    influencer: parseNumber,
                    shaper: parseNumber,
                    producer: parseNumber,
                    contemplator: parseNumber,
                    overallIntensity: parseNumber
                };

                let parsedParams = [];
                params.forEach(param => {
                    let obj = {};
                    Object.keys(parseKeys).forEach(key => {
                        if (param[key])
                            obj[key] = parseKeys[key](key, param[key]);       
                    }); 
                    parsedParams.push(obj);
                });

                let lgGrid = document.getElementById("language-gram-grid");
                let lg = document.getElementById("language-gram-1");
                for (let i = 0; i < parsedParams.length; i++) {
                    if (i > 0) {
                        let divClone = lg.cloneNode(true); // the true is for deep cloning
                        divClone.setAttribute("id", "language-gram-" + (i + 1));
                        lgGrid.appendChild(divClone);
                    }
                    try {
                        displayLanguageGram(i + 1, parsedParams[i]);
                    } catch (e) {
                        // Error.
                        ERROR.displayAlertInDoc(e);
                    }
                }
            } catch (e) {
                ERROR.displayAlertInDoc(e);
            }
        </script>
    </body>
</html>